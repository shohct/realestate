---
title: "Real Estate Analysis"
author: "sho"
date: "7/28/2020"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r data, include = FALSE, message = FALSE}

# Read data from Github to conduct analysis

library(RCurl)
library(readr)
library(dplyr)
library(purrr)
library(ggplot2)
library(tidyr)
library(knitr)
library(reshape2)

url <- getURL("https://raw.githubusercontent.com/shohct/realestate/master/RealestateData.csv")
data <- read_csv(url)

data <- data %>% 
    mutate(bargaindiff = AskingPrice - SoldPrice,
           SoldDate = as.Date(SoldDate, "%m/%d/%Y"))
```

### Preliminary EDA on real estate data

The data used for this analysis was manually entered by the author obtained from https://www.zealty.ca/.
```{r preview, echo = FALSE}
# Preview data
kable(head(data, 5))

sqftdiff <- round(colMeans(subset(data, Bed == 2, select = Sqft)) - colMeans(subset(data, Bed == 1, select = Sqft)), 2)
```

Summary statistics on sold price, asking price, price per sqft, sqft, age, and # of days on market were examined and compared between one-bedroom apartments and two-bedroom apartments. 

The plot below shows that while both the asking and sold price of 2-bedroom condos are higher than 1-bedroom condos, when divided by sqft, the price per sqft is lower for 2-bedroom condos. This is mostly contributed by 2-bedroom condos having an overall higher square footage than 1-bedrooms (on average, 2-bedroom condos are `r sqftdiff` sqft larger than 1-bedroom condos.)

```{r EDA, echo = FALSE, fig.height = 6, fig.width = 10}
# Text review
data %>% 
  select(SoldPrice, AskingPrice, Bed, Sqft, Age, DaysOnMarket, PriceSqft) %>% 
  split(.$Bed) %>% 
  map(summary)

# Plot it - need to pivot data from wide to long to use facet_wrap for all y values
data %>% 
  mutate(Bed = factor(Bed, labels = c("1-Bed", "2-Bed"))) %>% 
  pivot_longer(cols = c(SoldPrice, AskingPrice, Sqft, Age, DaysOnMarket, PriceSqft),
               names_to = "DataType",
               values_to = "Value") %>% 
  ggplot(aes(Bed, Value)) +
  geom_boxplot(aes(fill = Bed)) +
  facet_wrap(~DataType, scales = "free_y") +
  scale_y_continuous(labels = scales::comma) +
  ggtitle("Comparison of multiple variables between 1-Bed and 2-Bed apartments") +
  ylab("") +
  xlab("") +
  labs(fill = "# of Bedrooms") +
  theme(legend.position = "top",
        legend.justification = 'left')
```

The difference between asking and sold price is investigated further to identify appropriate negotiation range. Considering there are some new apartments in the data that could only be sold at asking price, those were excluded in the following analysis.

Initial review of the data found minimal correlations between different real estate variables and the bargained difference. The only variable showing slightly higher correlation is asking price of 2-bedroom condos.

A logarithmic growth between the number of days on market and bargained difference was noted, where the curve flattens after approximately 30 days on the market. This observation is found for both 1-bedroom and 2-bedroom apartments.
```{r bargaindiff, echo = FALSE, message = FALSE, fig.height = 10, fig.width = 10}

kable(data %>% 
  filter(Age != 0) %>% 
  group_by(Bed) %>% 
  summarize(AvgDiff = mean(bargaindiff),
            MedianDiff = median(bargaindiff),
            MinDiff = min(bargaindiff),
            MaxDiff = max(bargaindiff)))

# Test what are potential factors that impact bargaining differences

data %>% 
  filter(Age != 0) %>% 
  mutate(Bed = as.character(Bed)) %>% 
  melt(id.vars = c("Bed", "bargaindiff"), 
       measure.vars = c("SoldPrice", "AskingPrice", "Age", "Sqft", "PriceSqft", "DaysOnMarket")) %>% 
  ggplot(aes(value, bargaindiff, col = Bed)) +
  geom_point(alpha = 0.3) +
  geom_smooth(se = FALSE) +
  facet_wrap(~variable, scales = "free_x", ncol = 2) +
  scale_x_continuous(labels = scales::comma) +
  scale_y_continuous(labels = scales::label_dollar()) +
  ggtitle("Relationships between Asking-Sold Price differences and other variables") +
  ylab("Asking - Sold Difference") +
  xlab("") +
  labs(fill = "# of Bedrooms") +
  theme(legend.position = "top",
        legend.justification = 'left') +
  theme_minimal()
```

``` {r marketxdiffplot, echo = FALSE, message = FALSE, fig.width = 10}
data %>% 
  filter(Age != 0) %>% 
  mutate(Bed = as.character(Bed)) %>% 
  melt(id.vars = c("Bed", "bargaindiff"), 
       measure.vars = c("DaysOnMarket")) %>% 
  ggplot(aes(value, bargaindiff, col = Bed)) +
  geom_point(alpha = 0.5) +
  geom_smooth(se = FALSE) +
  facet_wrap(~variable, scales = "free_x", ncol = 2) +
  scale_x_continuous(labels = scales::comma, breaks = seq(0, max(data$DaysOnMarket) + 10, by = 10)) +
  scale_y_continuous(labels = scales::label_dollar()) +
  ggtitle("Relationships between Asking-Sold Price differences and # of Days on Market") +
  ylab("Asking - Sold Difference") +
  xlab("") +
  labs(fill = "# of Bedrooms") +
  theme_light() + 
  theme(legend.position = "top",
        legend.justification = 'left',
        panel.grid.minor.x = element_blank()) +
  geom_vline(xintercept = 30, linetype = "dashed", colour = "green4", size=1)
```

### Impact of COVID on Real Estate Market
```{r timeseries, echo = FALSE}

data %>% 
  filter(strftime(SoldDate, format = "%Y") == 2020) %>% 
  mutate(soldweek = strftime(SoldDate, format = "%V")) %>% 
  group_by(soldweek) %>% 
  count() %>% 
  ggplot(aes(soldweek, n)) +
  geom_line()
  pivot_longer(cols = c(SoldPrice, AskingPrice, DaysOnMarket, bargaindiff), 
               names_to = "DataType",
               values_to = "Value") %>% 
  ggplot(aes(soldweek, Value, fill = Bed)) +
  geom_line() +
  facet_wrap(~DataType)

# Correlation
#pairs(~bargaindiff+AskingPrice+SoldPrice+Sqft+PriceSqft+DaysOnMarket, data = data, main = "test")
#cor(data$AskingPrice, data$bargaindiff)
```
